<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <title>autosetup - News</title>
    <link rel="stylesheet" type="text/css" href="../css/style.css" media="screen">
    <link rel="stylesheet" type="text/css" href="../css/sh_style.css" media="screen">
    
    <link rel="alternate" type="application/rss+xml" title="News" href="../feed.xml">
    
    <script src="../javascript/sh_main.min.js" type="text/javascript"></script>
    <script src="../javascript/sh_lang.js" type="text/javascript"></script>
 	
 	<script type="text/javascript">
 	  var _gaq = _gaq || [];
 	  _gaq.push(['_setAccount', 'UA-23178588-3']);
 	  _gaq.push(['_trackPageview']);
 
 	  (function() {
 		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
 	  })();
 	</script>
 	
    <meta name="generator" content="Nanoc 4.12.19">
  </head>
  <body>
    <div id="header">
      <h1 id="blog-title">autosetup</h1>
      <p id="description">A build environment "autoconfigurator"</p>
    </div>
    <div id="content">
        <div class="breadcrumbs">
        
        <a id="rss" title="News RSS Feed" href="../feed.xml"><img src="../img/rssicon.png"></a>
        
        
            <a href="../">Overview</a>
            » 
        
            <a href="./">News</a>
            
        
        </div>
        <div class="main" id="news">
        
        
<div class="main" id="main">
<p class="articledate">Thursday, 18 August 2022</p>
<h2 class="news"><a href="../articles/autosetup-071/">autosetup 0.7.1</a></h2>


<p><strong>autosetup</strong> v0.7.1 has been released.</p>

<p>Changes since v0.7.0</p>

<p>Major improvements:</p>

<ul>
  <li>improve handling of CFLAGS, etc. See <a href="../articles/handling-cflags/">CFLAGS Handling</a></li>
</ul>

<p>Minor changes and bug fixes:</p>

<ul>
  <li>autosetup-find-tclsh will now build jimsh0 in the current directory</li>
  <li>pkg-config: invocation of -print-sysroot is now correct</li>
  <li>config.guess, config.sub: update to 2021-06-03</li>
  <li>cc-check-tools: fix when command includes args</li>
  <li>define-push: simplifies define management</li>
</ul>



</div>

<div class="main" id="main">
<p class="articledate">Wednesday, 17 August 2022</p>
<h2 class="news"><a href="../articles/handling-cflags/">Handling CFLAGS</a></h2>


<p>One question that comes up quite often is, “What is the right way of handling
CFLAGS within <a href="../">autosetup</a> (also autoconf, automake, etc.) and the Makefiles for
the best user experience?” – <a href="https://stackoverflow.com/questions/51606653/allowing-users-to-override-cflags-cxxflags-and-friends">stack overflow</a>.
<a href="https://www.gnu.org/software/automake/">automake</a> spends some time on this –
<a href="https://www.gnu.org/software/automake/manual/html_node/Flag-Variables-Ordering.html">26.6 Flag Variables Ordering</a>
however it doesn’t answer all the questions that we might want answered.
Below is my attempt to untangle the confusion and provide a canonical best
way to handle CFLAGS with autosetup and make (or similar).</p>

<p>One fundamental consideration is that CFLAGS (and CPPFLAGS, CXXFLAGS)
are all user-specified and the user’s wishes should be respected above all else.
This means that overwriting the user’s settings by changing CFLAGS or adding
additional flags after the user’s settings is not acceptable. With this in mind,
let’s look at all the points where flags to the C compiler could be specified.</p>

<p>First the user can provide flags in the environment or on the command
line to <code>configure</code> that we will name (1) and (2).</p>

<pre class="sh_unix">$ CFLAGS=-Dd1 ./configure CFLAGS=-Dd2
</pre>

<p>Next the user can provide flags in the environment or on the commandline to make or equivalent
that we will name (3) and (4).</p>

<pre class="sh_unix">$ CFLAGS=-Dd3 make CFLAGS=-Dd4
</pre>

<p>Finally if no explicit CFLAGS are provided by the user, use <code>-g -O2</code>, which we will name (0).</p>

<p>In addition, <code>configure</code> may wish to add additional flags based on <code>configure</code> tests or user
options, but these should not affect CFLAGS.</p>

<pre class="sh_autosetup"># If supported, add this flag to compiler flags
cc-check-flags -std=c99
</pre>

<p>And also we may we wish to add to CFLAGS within the makefile based on settings.
(This example could have been done in auto.def instead - it is just indicative).
Simlarly this should not affect the user’s CFLAGS settings.</p>

<pre class="sh_unix">ifeq(@SHARED@,1)
# Except we don't want to append to CFLAGS
CFLAGS += -dynamic
endif
</pre>

<p>Now what behaviour provides the best user experience? It is reasonable for (2) to override (1), especially
as CFLAGS may simply be set in the environment, so the explicit setting on the command line
should take precedence. Similarly, (4) should override (3) for similar reasons. It is also clear that
(4) should take precedence over (1) and (2) as this is a later phase. One thing that is not entirely
clear is whether (3) should override (2). For simplicity we will say it should as otherwise we would
need to distiguish beteen (1) and (2) in the Makefile. Finally, for CFLAGS all of (1) - (4) should
override (0). Now as we said that the user’s selection is the highest precedence, our command line
should clearly be.</p>

<pre class="sh_makefile">cc &lt;other-flags&gt; $CFLAGS -c ... -o ...
</pre>

<p>With the user’s selection last, overriding other flags that we will discuss shortly, and
where CFLAGS is defined as below, where the notation means that the first value that is set
is chosen.</p>
<pre class="sh_unix">CFLAGS := (4) || (3) || (2) || (1) || (0)
</pre>

<p>Note that CPPFLAGS can be specified by the user in all the same ways, except that there is no
default if not specified. The ordering between CFLAGS and CPPFLAGS is not clear, but we may as well follow
the gnu make approach:</p>
<pre class="sh_makefile"># default
COMPILE.c = $(CC) $(CFLAGS) $(CPPFLAGS) $(TARGET_ARCH) -c
</pre>

<p>So then we have:</p>
<pre class="sh_makefile">cc &lt;other-flags&gt; $CFLAGS $CPPFLAGS -c ... -o ...
</pre>

<p>Now we only need to decide how configure-derived flags are set and made available to make.
While most autosetup checks don’t do anything with CFLAGS by default (it is up to the auto.def
developer to make the flags available), <code>cc-check-flags</code> unfortunately (as of autosetup 0.7.0) 
modifieds CFLAGS. This is not OK as CFLAGS is a user value, and should not be touched by autosetup.
Therefore, as of autosetup 0.7.1, <code>cc-check-flags</code> now adds to AS_CFLAGS instead (autosetup CFLAGS).
This makes the recommendation of how to handle CFLAGS in auto.def simple. All flags are added to AS_CFLAGS
(or AS_CPPFLAGS or AS_CXXFLAGS). e.g.</p>

<pre class="sh_autosetup"># Adds to AS_CFLAGS
cc-check-flags -std=c99
# Add profiling if selected
if {[opt-bool profiling]} {
	define-append AS_CFLAGS -pg
}
</pre>

<p>And finally we need to determine how flags can be added in the Makefile.
It is simplest if we use the same AS_CFLAGS as autosetup. e.g.</p>

<pre class="sh_makefile">ifeq(@SHARED@,1)
AS_CFLAGS += -dynamic
endif
</pre>

<p>Now the only remaining challenge is to ensure that the Makefile implements
our desired command line:</p>

<pre class="sh_makefile">cc $(AS_CFLAGS) $(AS_CPPFLAGS) $CFLAGS $CPPFLAGS -c ... -o ...
</pre>

<p>We <em>could</em> start by trying this:</p>

<pre class="sh_makefile">CFLAGS += @AS_CFLAGS@ @AS_CPPFLAGS@ @CFLAGS@ @CPPFLAGS@
</pre>

<p>However this does not work as these will take precedence over the user flags.
As there is no way to prepend flags, we could try the cumbersome:</p>

<pre class="sh_makefile">override CFLAGS := @AS_CFLAGS@ @AS_CPPFLAGS@ $(CFLAGS)
</pre>

<p>But my preference is for the simpler solution to either take over
the implicit rule entirely, or replace the compile line. Therefore in gnu
make we can do:</p>
<pre class="sh_makefile"># Use configure versions if not set during make
CFLAGS ?= @CFLAGS@
CPPFLAGS ?= @CPPFLAGS@
# ensure we get the ordering we need
COMPILE.c = $(CC) @AS_CFLAGS@ @AS_CPPFLAGS@ $(CFLAGS) $(CPPFLAGS) $(TARGET_ARCH) -c
</pre>

<p>(Note that we could changed to <code>CFLAGS = @CFLAGS@</code> if we wanted to ignore (3))</p>

<p>Alternatively replace the rule entirely:</p>

<pre class="sh_makefile"># This may be gnu make only
%.o: %.c
        $(CC) @AS_CFLAGS@ @AS_CPPFLAGS@ $(CFLAGS) $(CPPFLAGS) $(TARGET_ARCH) -c $&lt; -o $@

# This may work better for bsd make
.c.o:
        $(CC) @AS_CFLAGS@ @AS_CPPFLAGS@ $(CFLAGS) $(CPPFLAGS) $(TARGET_ARCH) -c $&lt; -o $@
</pre>

<p>This is implemented in <a href="https://github.com/msteveb/autosetup/blob/master/examples/typical/Makefile.in">examples/typical/Makefile.in</a>
If you have a suggestion why one Makefile approach is better than the others, please
make a comment in <a href="https://github.com/msteveb/autosetup/discussions">Discussions</a>.</p>



</div>

<div class="main" id="main">
<p class="articledate">Wednesday, 23 September 2020</p>
<h2 class="news"><a href="../articles/autosetup-070/">autosetup 0.7.0</a></h2>


<p><strong>autosetup</strong> v0.7.0 has been released.</p>

<p>Changes since v0.6.9</p>

<p>Major improvements:</p>

<ul>
  <li>options: improved option handling, consistency and documentation</li>
</ul>

<p>Minor changes and bug fixes:</p>

<ul>
  <li>Avoid adding duplicates to $CONFIGURE_OPTS and $AUTO_REMAKE</li>
  <li>pkg-config: Improve cross compiling support, identify dependency issues, pkg-config-get-var</li>
  <li>cc: $CXX is set to the empty string if not found rather than false</li>
  <li>Add support for Tcl 8.7</li>
</ul>



</div>

<div class="main" id="main">
<p class="articledate">Friday, 21 June 2019</p>
<h2 class="news"><a href="../articles/autosetup-069/">autosetup 0.6.9</a></h2>


<p><strong>autosetup</strong> v0.6.9 has been released.</p>

<p>As there has been no release notes for a while, here are the changes since v0.6.2</p>

<p>Major improvements:</p>

<ul>
  <li>make-template: Support nesting, better conditionals, @define and @include</li>
  <li>Make it possible to use a system-installed autosetup.  e.g. autosetup –sysinstall=/usr/local</li>
  <li>Add initial pkg-config support</li>
  <li>Add an extensible init system with autosetup –init=&lt;type&gt;</li>
</ul>

<p>Minor changes and bug fixes:</p>

<ul>
  <li>define-append now ignores empty values</li>
  <li>define-append: improved check for duplicates</li>
  <li>cc-shared: always use -fPIC</li>
  <li>cc-shared: Add support for RPATH</li>
  <li>cc-shared: Add $STRIPLIBFLAGS</li>
  <li>system: add support for –runstatedir</li>
  <li>system: add abs_top_srcdir and abs_top_builddir</li>
  <li>options-defaults provides a way to change the default options from auto.def</li>
  <li>Never honor prefix for /var, honor only if != /usr for /etc</li>
  <li>make-template: Don’t write file if unchanged</li>
  <li>Allow $autosetup_tclsh to select the preferred tclsh</li>
  <li>Add cc-path-progs</li>
  <li>cc: drop empty -cflags, -includes, -libs</li>
  <li>cc: tests should use LIBS and LDFLAGS</li>
  <li>opt-bool: allow boolean options multiple times</li>
  <li>opt-bool: accepts -nodefault option</li>
  <li>cc-lib: add cc-check-alloca and cc-signal-return-type</li>
  <li>Fix cc-check-members for members of structs</li>
  <li>Set srcdir to a fully qualified path</li>
  <li>Add support for undefine</li>
  <li>Allow –init and –install to be combined</li>
  <li>Update config.{sub,guess} from automake-1.15</li>
  <li>Add ‘cctest -nooutput 1’ to consider any compiler output as an error</li>
</ul>

<p>Incompatibilities introduced:</p>

<ul>
  <li>Syntax of @if statements has changed in make-template</li>
  <li>Remove –with-xxx and –without-xxx synonyms</li>
  <li>opt-val now returns a list</li>
</ul>



</div>

<div class="main" id="main">
<p class="articledate">Tuesday, 19 July 2011</p>
<h2 class="news"><a href="../articles/autoconf-migration/">Automatic autoconf migration tool</a></h2>


<p>Although <strong>autosetup</strong> configurations are generally easy to create,
developers moving a complex project from <strong>autoconf</strong> to autosetup
may still find it tedious to create the <strong>auto.def</strong> configuration
file.</p>

<p>To simplify migration from autoconf, autosetup includes a migration
tool which will automatically convert a <strong>configure.in</strong> or <strong>configure.ac</strong>
file to an auto.def file.</p>

<p>Consider the following migration of <a href="http://tinytcl.sourceforge.net/">tinytcl</a>:</p>

<pre class="sh_unix">$ cd tinytcl
$ ~/src/autosetup.git/migrate-autoconf
Migrating configure.ac to auto.def
Created auto.def. Now edit to resolve items marked XXX
$ ~/src/autosetup.git/autosetup --install
Installed autosetup v0.6.2 to autosetup/
I see configure, but not created by autosetup, so I won't overwrite it.
Use autosetup --init --force to overwrite.
$ ./autosetup/autosetup --init --force
I will overwrite the existing configure because you used --force.
</pre>

<p>Now the migrated auto.def can be edited. Before editing it looks something like this:</p>

<pre class="sh_autosetup"># Created by migrate-autoconf - fix items marked XXX

use cc cc-lib

options {
    shared=0         =&gt;  {Build a shared library}
    history=0        =&gt;  {Enable history support}
    debug=0          =&gt;  {Enable debugging command: cmdtrace}
    fork=1           =&gt;  {Do not use fork (no exec, etc.)}
    syslog=0         =&gt;  {Build the syslog extension}
}

#                                               -*- Autoconf -*-
# Process this file with autoconf to produce a configure script.


# XXX autosetup automatically substitutes all define'd values
#     In general, simply 'define' the value rather than using a shell
#     variable and AC_SUBST.
#
# XXX AC_SUBST TARGET_PLATFORM $ac_cv_host

# Checks for programs.

# XXX TINYTCL_IS_STATIC=1
if {[opt-bool shared]} {
    # XXX if test "x$enableval" = "xyes" ; then
    msg-result "* creating shared library"
    # XXX TINYTCL_IS_STATIC=
    # XXX fi
}
# XXX AC_SUBST TINYTCL_IS_STATIC $TINYTCL_IS_STATIC
...
</pre>

<p>After editing, <em>auto.def</em> looks more like:</p>

<pre class="sh_autosetup">...
define TARGET_PLATFORM [get-define host]

define TINYTCL_IS_STATIC 1
if {[opt-bool shared]} {
    msg-result "* creating shared library"
    define TINYTCL_IS_STATIC 0
}
...
</pre>

<p>The final edited version is available at in the autosetup repository
as <a href="https://github.com/msteveb/autosetup/blob/master/examples/migration/tinytcl/auto.def.edited">auto.def.edited</a>
along with additional examples.</p>

<p>Note that <strong>migrate-autoconf</strong> only understands a common subset of autoconf macros and
uses various heuristics to perform the migration. Nonetheless, migrate-autoconf can 
significantly speed up migration from autoconf.</p>



</div>

<div class="main" id="main">
<p class="articledate">Thursday, 14 July 2011</p>
<h2 class="news"><a href="../articles/fossil-adopts-autosetup/">Fossil adopts autosetup</a></h2>


<p>Recently the <a href="http://fossil-scm.org/">Fossil SCM</a> has been adopted
by <a href="http://wiki.tcl.tk/">Tcl/Tk</a> as a replacement for CVS.  Now the
Tcl-based <a href="http://msteveb.github.io/autosetup/">autosetup</a> has
been adopted as the development configuration system for
<a href="http://www.fossil-scm.org/">Fossil</a>.</p>

<p>Fossil is similar to many open source projects that are required
to support a number of different platforms. The obvious approach
is to use autoconf and possibly automake, but <a href="http://identi.ca/group/fossil#notice-76160895">many people</a>
find that approach <a href="http://www.mail-archive.com/fossil-users@lists.fossil-scm.org/msg04899.html">frustrating</a>.</p>

<p>Some of the immediate benefits of autosetup are support for cross compilation
and easily allowing Fossil to be build with different options.</p>



</div>

<p><a href="../articles/">See All News Articles »</a></p>


        </div>
    </div>
    <div id="sidebar">
      <h2>About autosetup</h2>
      <ul>
        
            
            <li><a href="../">Overview</a></li>
        
            
            <li><span class="active">News</span></li>
        
            
            <li><a href="../download/">Download</a></li>
        
            
            <li><a href="../user/">Running autosetup</a></li>
        
            
            <li><a href="../developer/">Developing</a></li>
        
            
            <li><a href="../developer/examples/">Examples</a></li>
        
            
            <li><a href="../license/">License</a></li>
        
            
            <li><a href="../why/">Motivation</a></li>
        
      </ul>
      <h2>Community</h2>
      <ul>
        <li><a href="https://github.com/msteveb/autosetup">autosetup on github</a></li>
        <li><a href="https://github.com/msteveb/autosetup/commits/master">» commit history</a></li>
        <li><a href="https://github.com/msteveb/autosetup/issues">» open issues</a></li>
      </ul>
    </div>
    
    <script language="javascript">sh_highlightDocument();</script>
  

</body></html>